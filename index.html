import React, { useState, useEffect, useCallback } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea"; // FIXED: Corrected import syntax
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid, AreaChart, Area } from 'recharts';
import { CheckCircle, XCircle, BarChart2, Lightbulb, Search, ExternalLink, ScrollText, DollarSign, Wallet, Verified, TrendingUp, ArrowLeft, Gem, RefreshCw, HandCoins, ChevronRight, TrendingDown, Clock, Scale, Twitter, Users } from "lucide-react";

// Constants
const AVAX_USD_PRICE = 19; // 1 AVAX is $19
const MOOCH_USD_PRICE = 0.00001541; // 1 Mooch is $0.00001541
const SIMULATED_GAS_FEE_AVAX = 0.002; // Fixed simulated gas fee in AVAX
const PRICE_IMPACT_FACTOR_TRADE = 0.00005; // Base factor for price change on trade
const SHILL_SCORE_INCREMENT = 5; // How much shill score increases per 'shill' action

// Helper to generate a dummy transaction hash
const generateTxHash = () => {
    return '0x' + Array.from({ length: 64 }, () => Math.floor(Math.random() * 16).toString(16)).join('');
};

// --- ProjectDetailsModal Component ---
const ProjectDetailsModal = ({ project, onClose, onBurnMooch, onSimulatePresale, onContribute, userHasMoochNFT, onSendForReview, onAcceptReview }) => {
  const [userContributedAmount, setUserContributedAmount] = useState(0);
  const [contributionAmountInput, setContributionAmountInput] = useState("");
  const [showHolders, setShowHolders] = useState(false); // State to toggle holders section

  // Calculate token holder allocations - MOVED OUTSIDE CONDITIONAL RENDER
  // Hooks must be called in the same order on every render.
  const calculateHolderAllocations = useCallback(() => {
      if (!project || !project.circulatingSupply || !project.tokenAllocation) return [];

      const totalTokens = project.circulatingSupply;
      let allocatedPercentage = 0;
      const allocations = [];

      // Add fixed allocations
      project.tokenAllocation.forEach(alloc => {
          const amount = (alloc.percentage / 100) * totalTokens;
          allocations.push({
              name: alloc.name === "Project Team" ? `${project.name} Team` : alloc.name, // Dynamic project name for team
              percentage: alloc.percentage,
              amount: amount
          });
          allocatedPercentage += alloc.percentage;
      });

      // Distribute remaining to random wallets and 'Other Wallets'
      const remainingPercentage = 100 - allocatedPercentage;
      const remainingAmount = (remainingPercentage / 100) * totalTokens;

      if (remainingPercentage > 0) {
          const numRandomWallets = 5; // Fixed number of random wallets for display
          let distributedRandomly = 0;

          for (let i = 0; i < numRandomWallets; i++) {
              // Distribute randomly, ensuring small amounts for each
              const randomPercent = (Math.random() * (remainingPercentage / numRandomWallets * 1.5 - remainingPercentage / numRandomWallets * 0.5) + remainingPercentage / numRandomWallets * 0.5);
              const actualPercent = Math.min(randomPercent, remainingPercentage - distributedRandomly); // Cap it
              if (actualPercent > 0.1) { // Only add if it's a meaningful percentage
                  const amount = (actualPercent / 100) * totalTokens;
                  allocations.push({
                      name: `Random Wallet ${String.fromCharCode(65 + i)}`, // A, B, C...
                      percentage: actualPercent,
                      amount: amount
                  });
                  distributedRandomly += actualPercent;
              }
          }

          const otherWalletsPercentage = remainingPercentage - distributedRandomly;
          if (otherWalletsPercentage > 0) {
              allocations.push({
                  name: "Other Wallets",
                  percentage: otherWalletsPercentage,
                  amount: (otherWalletsPercentage / 100) * totalTokens
              });
          }
      }

      // Sort by percentage held descending
      return allocations.sort((a, b) => b.percentage - a.percentage);

  }, [project]); // Dependency array: Recalculate if project data changes

  // Only compute holderAllocations if the project is launched
  // The useCallback is defined always, but its result is only used conditionally
  const holderAllocations = project && project.status === "Launched" ? calculateHolderAllocations() : [];


  useEffect(() => {
    if (project) {
      const currentUserId = 'simulatedUserId';
      const contributed = project.userContributions[currentUserId] || 0;
      setUserContributedAmount(contributed);
      setShowHolders(false); // Reset holders view when project changes
    } else {
        setUserContributedAmount(0);
    }
  }, [project]);

  if (!project) return null;

  const handleContributionSubmit = (e) => {
    e.preventDefault();
    const amount = parseFloat(contributionAmountInput);

    if (isNaN(amount) || amount <= 0) {
      console.error("Please enter a valid positive contribution amount.");
      return;
    }
    if (amount < project.minContribution) {
      console.error(`Minimum contribution is $${project.minContribution} AVAX.`);
      return;
    }

    const remainingUserCap = project.maxContributionPerUser - userContributedAmount;
    if (amount > remainingUserCap) {
        console.error(`You can only contribute up to $${remainingUserCap.toFixed(2)} AVAX more to this project.`);
        return;
    }

    const remainingPresaleCap = project.presaleTarget - project.currentContributions;
    if (amount > remainingPresaleCap) {
        console.error(`The presale only needs $${remainingPresaleCap.toFixed(2)} AVAX more to reach its target.`);
        return;
    }

    const currentUserId = 'simulatedUserId';
    onContribute(project.name, amount, currentUserId);
    setContributionAmountInput("");
  };

  const isPresaleComplete = project.currentContributions >= project.presaleTarget;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
      <div className="bg-gray-900 border border-purple-700 rounded-lg shadow-2xl max-w-2xl w-full p-6 space-y-6 animate-scale-in overflow-y-auto max-h-[90vh]">
        <div className="flex justify-between items-center border-b border-gray-700 pb-4">
          <h2 className="text-3xl font-bold text-purple-400">{project.name} Details</h2>
          <Button onClick={onClose} className="text-gray-400 hover:text-white transition-colors text-lg" variant="ghost">
            &times;
          </Button>
        </div>

        <div className="space-y-4 text-gray-300">
          <p className="text-lg leading-relaxed">{project.fullDescription}</p>

          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
            <div className="flex items-center">
              <Lightbulb className="w-4 h-4 mr-2 text-yellow-400" />
              <span>Status: <span className="font-semibold text-yellow-300">{project.status}</span></span>
            </div>
            <div className="flex items-center">
              {project.moochBurned ? (
                <CheckCircle className="w-4 h-4 mr-2 text-green-400" />
              ) : (
                <XCircle className="w-4 h-4 mr-2 text-red-400" />
              )}
              <span>1M Mooch Burned: <span className="font-semibold">{project.moochBurned ? "Yes" : "No"}</span></span>
            </div>

            {project.shillScore > 0 && (
                <div className="flex items-center">
                    <Scale className="w-4 h-4 mr-2 text-pink-400" />
                    <span>Shill Score: <span className="font-semibold text-pink-300">{project.shillScore}</span></span>
                </div>
            )}
             <div className="flex items-center">
                <BarChart2 className="w-4 h-4 mr-2 text-blue-400" />
                <span>Current Votes: <span className="font-semibold text-blue-300">{project.votes.toLocaleString()}</span></span>
            </div>

            {(project.status === "Voting" || project.status === "Presale Active" || project.status === "Launched") && (
              <>
                <div className="flex items-center">
                  <DollarSign className="w-4 h-4 mr-2 text-green-400" />
                  <span>Presale Target: <span className="font-semibold text-green-300">{project.presaleTarget ? `$${project.presaleTarget.toLocaleString()} AVAX` : 'N/A'}</span></span>
                </div>
                <div className="flex items-center">
                  <Wallet className="w-4 h-4 mr-2 text-purple-400" />
                  <span>Min Contribution: <span className="font-semibold text-purple-300">{project.minContribution ? `$${project.minContribution.toLocaleString()} AVAX` : 'N/A'}</span></span>
                </div>
                 <div className="flex items-center">
                  <Wallet className="w-4 h-4 mr-2 text-orange-400" />
                  <span>Max per person: <span className="font-semibold text-orange-300">{project.maxContributionPerUser ? `$${project.maxContributionPerUser.toLocaleString()} AVAX` : 'N/A'}</span></span>
                </div>
                <div className="flex items-center">
                  <DollarSign className="w-4 h-4 mr-2 text-cyan-400" />
                  <span>Token Price: <span className="font-semibold text-cyan-300">{project.tokenPrice ? `${project.tokenPrice.toFixed(4)} AVAX` : 'N/A'}</span></span>
                </div>
                <div className="flex items-center">
                  <Verified className="w-4 h-4 mr-2 text-indigo-400" />
                  <span>Audit Status: <span className="font-semibold text-indigo-300">{project.auditStatus || 'Pending'}</span></span>
                </div>
                {project.status === "Launched" && (
                    <div className="flex items-center">
                        <Users className="w-4 h-4 mr-2 text-blue-400" />
                        <span>Circulating Supply: <span className="font-semibold text-blue-300">{project.circulatingSupply.toLocaleString()} {project.name}</span></span>
                    </div>
                )}
              </>
            )}
            {project.status === "Presale Active" && (
                <div className="flex items-center col-span-full bg-gray-800 p-2 rounded-md">
                    <TrendingUp className="w-5 h-5 mr-2 text-lime-400 animate-bounce" />
                    <span className="text-lg font-bold text-lime-300">
                        Raised: ${project.currentContributions.toLocaleString()} / ${project.presaleTarget.toLocaleString()} AVAX
                    </span>
                </div>
            )}
             {project.status === "Launched" && (
                <div className="flex items-center col-span-full bg-green-800 p-3 rounded-md justify-center">
                    <CheckCircle className="w-6 h-6 mr-3 text-green-300 animate-pulse" />
                    <span className="text-xl font-bold text-green-100">
                        PROJECT LAUNCHED!
                    </span>
                </div>
            )}
          </div>

          <div className="flex flex-wrap gap-4 mt-6">
            {project.websiteUrl && (
              <a href={project.websiteUrl} target="_blank" rel="noopener noreferrer" className="flex items-center text-blue-400 hover:underline hover:text-blue-300 transition-colors">
                <ExternalLink className="w-4 h-4 mr-1" /> Project Website
              </a>
            )}
            {project.whitepaperUrl && (
              <a href={project.whitepaperUrl} target="_blank" rel="noopener noreferrer" className="flex items-center text-blue-400 hover:underline hover:text-blue-300 transition-colors">
                <ScrollText className="w-4 h-4 mr-1" /> Whitepaper
              </a>
            )}
          </div>
        </div>

        {/* Action Buttons */}
        <div className="pt-4 border-t border-gray-700 flex flex-col sm:flex-row justify-end gap-3">
          {/* Burn Mooch Button */}
          {!project.moochBurned && (project.status === "Pending Burn") && (
            <Button
              onClick={() => onBurnMooch(project.name)}
              className="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105"
            >
              ðŸ”¥ Burn 1M $Mooch
            </Button>
          )}

          {/* Send for Review Button */}
          {project.moochBurned && project.status === "Submitted" && (
            <Button
              onClick={() => onSendForReview(project.name)}
              className="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105"
            >
              <Clock className="mr-2 h-5 w-5" /> Send for Money Bears Review
            </Button>
          )}

          {/* Money Bears Accept Button (Simulated Admin Action) */}
          {project.status === "Under Review" && (
            <Button
              onClick={() => onAcceptReview(project.name)}
              className="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105"
            >
              <CheckCircle className="mr-2 h-5 w-5" /> Money Bears Accept Project
            </Button>
          )}

          {/* Simulate Presale Launch Button (Admin/Demo only) */}
          {project.status === "Voting" && (
            <Button
              onClick={() => onSimulatePresale(project.name)}
              className="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105"
            >
              ðŸš€ Simulate Presale Launch
            </Button>
          )}

          {/* Contribution Section */}
          {project.status === "Presale Active" && (
            userHasMoochNFT ? (
              isPresaleComplete ? (
                <p className="text-green-400 font-semibold text-lg text-center sm:text-right w-full">Presale Completed!</p>
              ) : (
                <form onSubmit={handleContributionSubmit} className="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                  <Input
                    type="number"
                    placeholder={`Contribute (max ${ (project.maxContributionPerUser - userContributedAmount).toFixed(2) }) AVAX`}
                    value={contributionAmountInput}
                    onChange={(e) => setContributionAmountInput(e.target.value)}
                    min={project.minContribution}
                    max={project.maxContributionPerUser - userContributedAmount}
                    step="0.01"
                    className="bg-gray-800 border border-gray-700 text-white placeholder-gray-500 focus:border-green-500 focus:ring-green-500 focus:ring-1"
                  />
                  <Button
                    type="submit"
                    className="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105"
                    disabled={userContributedAmount >= project.maxContributionPerUser || isPresaleComplete}
                  >
                    Contribute
                  </Button>
                </form>
              )
            ) : (
              <p className="text-red-400 font-semibold text-lg text-center sm:text-right w-full">
                Mooch NFT required to contribute!
              </p>
            )
          )}
           {/* View Holders Button for Launched Projects */}
          {project.status === "Launched" && (
              <Button
                  onClick={() => setShowHolders(!showHolders)}
                  className="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105"
              >
                  <Users className="mr-2 h-5 w-5" /> {showHolders ? 'Hide Holders' : 'View Holders'}
              </Button>
          )}
        </div>

        {/* Holders Section - Conditionally rendered */}
        {project.status === "Launched" && showHolders && (
            <div className="mt-8 bg-gray-800 p-4 rounded-lg border border-gray-700">
                <h3 className="text-xl font-bold text-center text-blue-300 mb-4 flex items-center justify-center">
                    <Users className="mr-2 h-5 w-5" /> Top Token Holders
                </h3>
                <div className="overflow-x-auto">
                    <table className="min-w-full divide-y divide-gray-700">
                        <thead className="bg-gray-700">
                            <tr>
                                <th scope="col" className="px-4 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                    Holder
                                </th>
                                <th scope="col" className="px-4 py-2 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">
                                    % Held
                                </th>
                                <th scope="col" className="px-4 py-2 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">
                                    Tokens Held
                                </th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-800">
                            {holderAllocations.map((holder, index) => (
                                <tr key={index} className={`${index % 2 === 0 ? 'bg-gray-800' : 'bg-gray-750'} hover:bg-gray-600 transition-colors`}>
                                    <td className="px-4 py-3 whitespace-nowrap text-sm font-medium text-white">
                                        {holder.name}
                                    </td>
                                    <td className="px-4 py-3 whitespace-nowrap text-sm text-right text-purple-300">
                                        {holder.percentage.toFixed(2)}%
                                    </td>
                                    <td className="px-4 py-3 whitespace-nowrap text-sm text-right text-cyan-300">
                                        {holder.amount.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
                <p className="text-xs text-gray-500 mt-4 text-center">
                    (Note: Token amounts are approximate for demonstration purposes.)
                </p>
            </div>
        )}
      </div>
    </div>
  );
};


// --- TradeLaunchedMemes Component ---
const TradeLaunchedMemes = ({ launchedProjects, onBackToArena, userAvaxBalance, userTokenBalances, onPerformTrade, userConnectedXAccount, onShillProject }) => {
    const SIMULATED_GAS_FEE_AVAX = 0.002;

    const [selectedProject, setSelectedProject] = useState(null);
    const [tradeDirection, setTradeDirection] = useState('buy'); // 'buy' or 'sell'
    const [inputAmount, setInputAmount] = useState("");
    const [slippage, setSlippage] = useState(0.5); // Default slippage 0.5%
    const [isTrading, setIsTrading] = useState(false);
    const [transactionResult, setTransactionResult] = useState(null); // { status: 'success'|'fail', message: string, txLink: string }
    const [chartDataType, setChartDataType] = useState('price'); // 'price' or 'mcap'

    // Set default selected project if available
    useEffect(() => {
        if (launchedProjects.length > 0 && !selectedProject) {
            setSelectedProject(launchedProjects[0]);
        }
    }, [launchedProjects, selectedProject]);

    // Generate dummy price/mcap data for the chart
    const generateChartData = useCallback((project) => {
        if (!project) return [];

        const data = [];
        const initialPrice = project.tokenPrice; // Base for historical data
        const currentPrice = project.currentPrice; // The current dynamic price from state
        const circulatingSupply = project.circulatingSupply;

        // Generate history for the last 24 periods (e.g., hours)
        for (let i = 0; i < 23; i++) {
            const historicalPrice = initialPrice * (1 + (Math.random() - 0.5) * 0.05); // Random fluctuation
            const historicalMcap = historicalPrice * circulatingSupply * AVAX_USD_PRICE;
            data.push({
                time: `${i < 10 ? '0' : ''}${i}:00`,
                price: parseFloat(historicalPrice.toFixed(6)),
                mcap: parseFloat(historicalMcap.toFixed(2)),
            });
        }
        // Add the current real-time price as the last data point
        data.push({
            time: 'Now',
            price: parseFloat(currentPrice.toFixed(6)),
            mcap: parseFloat((currentPrice * circulatingSupply * AVAX_USD_PRICE).toFixed(2))
        });
        return data;
    }, [AVAX_USD_PRICE]);

    const projectChartData = selectedProject ? generateChartData(selectedProject) : [];

    // Custom Tooltip for Recharts
    const CustomTooltip = ({ active, payload, label }) => {
      if (active && payload && payload.length) {
        const dataPoint = payload[0].payload;
        return (
          <div className="bg-gray-800 border border-gray-700 p-3 rounded-lg shadow-lg text-white text-sm">
            <p className="font-bold text-gray-300">{label}</p>
            {chartDataType === 'price' ? (
                <p>Price: <span className="font-semibold">{dataPoint.price.toFixed(6)} AVAX</span></p>
            ) : (
                <p>Market Cap: <span className="font-semibold">${dataPoint.mcap.toLocaleString()} USD</span></p>
            )}
            <p className="mt-1 text-xs text-gray-500">Click chart for more info (simulated)</p>
          </div>
        );
      }
      return null;
    };


    // Calculate amounts based on trade direction and inputs
    const calculateTradeAmounts = useCallback(() => {
        if (!selectedProject || !inputAmount || isNaN(parseFloat(inputAmount))) {
            return { outputAmount: 0, rawOutput: 0, priceImpact: 0, gasFee: SIMULATED_GAS_FEE_AVAX };
        }

        const amount = parseFloat(inputAmount);
        const currentPrice = selectedProject.currentPrice;
        const effectiveSlippage = slippage / 100;

        let outputAmount = 0;
        let rawOutput = 0; // Amount before slippage
        let simulatedPriceImpact = 0;

        simulatedPriceImpact = Math.log10(Math.max(1, amount)) * PRICE_IMPACT_FACTOR_TRADE;
        simulatedPriceImpact = Math.min(simulatedPriceImpact, 0.05);

        if (tradeDirection === 'buy') {
            rawOutput = (amount / currentPrice);
            outputAmount = rawOutput * (1 - effectiveSlippage);
        } else { // sell
            rawOutput = (amount * currentPrice);
            outputAmount = rawOutput * (1 - effectiveSlippage);
        }

        return {
            outputAmount: Math.max(0, outputAmount),
            rawOutput: rawOutput,
            priceImpact: simulatedPriceImpact,
            gasFee: SIMULATED_GAS_FEE_AVAX
        };
    }, [selectedProject, inputAmount, slippage, tradeDirection, SIMULATED_GAS_FEE_AVAX, PRICE_IMPACT_FACTOR_TRADE]);

    const { outputAmount, rawOutput, priceImpact, gasFee } = calculateTradeAmounts();

    const handleSwap = () => {
        if (!selectedProject) {
            setTransactionResult({ status: 'fail', message: 'Please select a token to trade.', txLink: '' });
            return;
        }
        const amount = parseFloat(inputAmount);
        if (isNaN(amount) || amount <= 0) {
            setTransactionResult({ status: 'fail', message: 'Please enter a valid amount.', txLink: '' });
            return;
        }

        setIsTrading(true);
        setTransactionResult(null);

        let success = true;
        let message = "";
        let priceChange = 0; // To simulate price increase/decrease

        if (tradeDirection === 'buy') {
            if (userAvaxBalance < amount + gasFee) {
                success = false;
                message = "Insufficient AVAX balance for this trade and gas fee.";
            } else {
                // Simulate price increase due to buying pressure
                // Price increase is relative to the percentage of circulating supply bought
                const tokensBeingBought = rawOutput; // Use rawOutput to represent tokens influencing price before slippage
                const percentageOfSupply = tokensBeingBought / selectedProject.circulatingSupply;
                priceChange = selectedProject.currentPrice * percentageOfSupply * 0.5; // Example factor 0.5 for impact
                message = `Successfully bought ${outputAmount.toFixed(4)} ${selectedProject.name} tokens!`;
            }
        } else { // sell
            const currentTokenBalance = userTokenBalances[selectedProject.name] || 0;
            if (currentTokenBalance < amount) {
                success = false;
                message = `Insufficient ${selectedProject.name} tokens for this trade.`;
            } else {
                if (userAvaxBalance < gasFee) {
                    success = false;
                    message = "Insufficient AVAX balance for gas fee.";
                } else {
                    // Simulate price decrease due to selling pressure
                    const tokensBeingSold = amount;
                    const percentageOfSupply = tokensBeingSold / selectedProject.circulatingSupply;
                    priceChange = -selectedProject.currentPrice * percentageOfSupply * 0.5; // Example factor 0.5 for impact
                    message = `Successfully sold ${amount.toFixed(4)} ${selectedProject.name} tokens for ${outputAmount.toFixed(4)} AVAX!`;
                }
            }
        }

        setTimeout(() => {
            setIsTrading(false);
            if (success) {
                onPerformTrade(
                    selectedProject.name,
                    tradeDirection,
                    amount, // Input amount (AVAX for buy, Token for sell)
                    outputAmount, // Output amount (Token for buy, AVAX for sell)
                    gasFee,
                    priceChange // Pass price change to App component
                );
                setTransactionResult({ status: 'success', message: message, txLink: `https://snowtrace.io/tx/${generateTxHash()}` });
                setInputAmount(""); // Clear input on success
            } else {
                setTransactionResult({ status: 'fail', message: message, txLink: '' });
            }
        }, 1500); // Simulate network delay
    };

    const handleShill = () => {
        if (!selectedProject) {
            console.error("No project selected to shill.");
            return;
        }
        if (!userConnectedXAccount) {
            console.error("Connect your X account to shill this meme!");
            setTransactionResult({status: 'fail', message: 'Connect your X account to shill this meme!', txLink: ''});
            return;
        }
        onShillProject(selectedProject.name);
        setTransactionResult({status: 'success', message: `You shilled ${selectedProject.name}! Hype increased!`, txLink: `https://x.com/intent/tweet?text=Just shilled $${selectedProject.name} on Mooch Launch Arena! Check it out! #Mooch #MemeCoin`});
    };


    return (
        <div className="min-h-screen bg-gradient-to-br from-gray-950 to-black text-white p-6 space-y-12 font-sans">
            <div className="text-center space-y-4 pt-8">
                <h1 className="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-yellow-600 drop-shadow-lg animate-pulse">
                    ðŸš€ Trade Launched Memes
                </h1>
                <p className="text-lg text-gray-300 max-w-2xl mx-auto leading-relaxed">
                    Explore and trade tokens from successfully launched Mooch projects.
                </p>
            </div>

            <div className="flex justify-center my-8">
                <Button
                    onClick={onBackToArena}
                    className="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105"
                >
                    <ArrowLeft className="mr-2 h-5 w-5" /> Back to Launch Arena
                </Button>
            </div>

            {launchedProjects.length === 0 ? (
                <p className="col-span-full text-center text-gray-500 text-lg py-10">
                    No projects have launched yet. Launch one in the arena to start trading!
                </p>
            ) : (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-6xl mx-auto">
                    {/* Trading Interface Card */}
                    <Card className="bg-gray-900 border border-yellow-700 p-6 rounded-xl shadow-2xl space-y-6">
                        <CardContent className="p-0 space-y-6">
                            <h2 className="text-2xl font-bold text-yellow-400 flex items-center">
                                <HandCoins className="mr-2 w-6 h-6" /> Trade Token
                            </h2>

                            {/* Token Selection */}
                            <div>
                                <label className="block text-gray-300 text-sm font-medium mb-2">Select Token</label>
                                <Select
                                    value={selectedProject ? selectedProject.name : ''}
                                    onValueChange={(value) => setSelectedProject(launchedProjects.find(p => p.name === value))}
                                >
                                    <SelectTrigger className="w-full bg-gray-800 border border-gray-700 text-white focus:ring-yellow-500 focus:border-yellow-500">
                                        <SelectValue placeholder="Choose a launched token" />
                                    </SelectTrigger>
                                    <SelectContent className="bg-gray-800 text-white border-gray-700">
                                        {launchedProjects.map(proj => (
                                            <SelectItem key={proj.name} value={proj.name}>
                                                {proj.name}
                                            </SelectItem>
                                        ))}
                                    </SelectContent>
                                </Select>
                            </div>

                            {selectedProject && (
                                <>
                                    {/* Buy/Sell Tabs */}
                                    <div className="flex bg-gray-800 rounded-lg p-1">
                                        <Button
                                            onClick={() => setTradeDirection('buy')}
                                            className={`flex-1 ${tradeDirection === 'buy' ? 'bg-purple-600 hover:bg-purple-700' : 'bg-transparent text-gray-400 hover:text-white'}`}
                                        >
                                            Buy
                                        </Button>
                                        <Button
                                            onClick={() => setTradeDirection('sell')}
                                            className={`flex-1 ${tradeDirection === 'sell' ? 'bg-purple-600 hover:bg-purple-700' : 'bg-transparent text-gray-400 hover:text-white'}`}
                                        >
                                            Sell
                                        </Button>
                                    </div>

                                    {/* Input Section */}
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-gray-300 text-sm font-medium mb-2">
                                                You {tradeDirection === 'buy' ? 'pay (AVAX)' : 'pay (Token)'}
                                            </label>
                                            <Input
                                                type="number"
                                                value={inputAmount}
                                                onChange={(e) => setInputAmount(e.target.value)}
                                                placeholder={`Amount in ${tradeDirection === 'buy' ? 'AVAX' : selectedProject.name}`}
                                                className="bg-gray-800 border border-gray-700 text-white placeholder-gray-500 focus:border-yellow-500 focus:ring-yellow-500"
                                                min="0"
                                                step="0.01"
                                            />
                                        </div>

                                        <div className="flex items-center justify-center text-gray-500">
                                            <ChevronRight className="rotate-90 w-6 h-6" />
                                        </div>

                                        <div>
                                            <label className="block text-gray-300 text-sm font-medium mb-2">
                                                You {tradeDirection === 'buy' ? `receive (${selectedProject.name})` : 'receive (AVAX)'}
                                            </label>
                                            <Input
                                                type="text"
                                                value={outputAmount.toFixed(4)}
                                                readOnly
                                                className="bg-gray-800 border border-gray-700 text-gray-300 cursor-not-allowed"
                                            />
                                        </div>
                                    </div>

                                    {/* Trade Details */}
                                    <div className="space-y-2 text-sm text-gray-400">
                                        <div className="flex justify-between items-center">
                                            <span>Price:</span>
                                            <span className="font-semibold text-white">
                                                1 {tradeDirection === 'buy' ? selectedProject.name : 'AVAX'} = {selectedProject.currentPrice.toFixed(6)} {tradeDirection === 'buy' ? 'AVAX' : selectedProject.name}
                                            </span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span>Slippage Tolerance:</span>
                                            <Input
                                                type="number"
                                                value={slippage}
                                                onChange={(e) => setSlippage(Math.max(0, Math.min(5, parseFloat(e.target.value))))} // Clamp between 0 and 5% for realism
                                                step="0.1"
                                                min="0"
                                                max="5"
                                                className="w-20 bg-gray-800 border border-gray-700 text-white text-right px-2 py-1"
                                            />
                                            <span>%</span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span>Gas Fee:</span>
                                            <span className="font-semibold text-white">{gasFee.toFixed(6)} AVAX</span>
                                        </div>
                                        {priceImpact > 0.0001 && (
                                            <div className="flex justify-between items-center text-red-400">
                                                <span>Price Impact:</span>
                                                <span className="font-semibold">~{(priceImpact * 100).toFixed(2)}%</span>
                                            </div>
                                        )}
                                    </div>

                                    {/* Balances */}
                                    <div className="text-sm text-gray-400 mt-4 border-t border-gray-800 pt-4">
                                        <div className="flex justify-between items-center">
                                            <span>Your AVAX Balance:</span>
                                            <span className="font-semibold text-white">{userAvaxBalance.toFixed(4)} AVAX</span>
                                        </div>
                                        {selectedProject && (
                                            <div className="flex justify-between items-center">
                                                <span>Your {selectedProject.name} Balance:</span>
                                                <span className="font-semibold text-white">
                                                    {(userTokenBalances[selectedProject.name] || 0).toFixed(4)} {selectedProject.name}
                                                </span>
                                            </div>
                                        )}
                                    </div>


                                    {/* Swap Button */}
                                    <Button
                                        onClick={handleSwap}
                                        className="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105"
                                        disabled={isTrading || !selectedProject || !inputAmount || isNaN(parseFloat(inputAmount)) || parseFloat(inputAmount) <= 0}
                                    >
                                        {isTrading ? (
                                            <RefreshCw className="animate-spin mr-2" />
                                        ) : (
                                            tradeDirection === 'buy' ? 'Swap AVAX for Token' : 'Swap Token for AVAX'
                                        )}
                                    </Button>

                                    {/* Shill Button */}
                                    <Button
                                        onClick={handleShill}
                                        className={`w-full font-semibold py-3 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 mt-2 ${userConnectedXAccount ? 'bg-blue-500 hover:bg-blue-600' : 'bg-gray-600 cursor-not-allowed'}`}
                                        disabled={!userConnectedXAccount || !selectedProject}
                                    >
                                        <Twitter className="mr-2 h-5 w-5" /> Shill This Meme!
                                    </Button>

                                    {/* Transaction Result */}
                                    {transactionResult && (
                                        <div className={`p-3 rounded-md mt-4 ${transactionResult.status === 'success' ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'}`}>
                                            <p className="font-medium">{transactionResult.message}</p>
                                            {transactionResult.txLink && (
                                                <a href={transactionResult.txLink} target="_blank" rel="noopener noreferrer" className="text-blue-400 hover:underline text-sm flex items-center mt-1">
                                                    View Transaction <ExternalLink className="ml-1 w-3 h-3" />
                                                </a>
                                            )}
                                        </div>
                                    )}
                                </>
                            )}
                        </CardContent>
                    </Card>

                    {/* Chart Card */}
                    <Card className="bg-gray-900 border border-blue-700 p-6 rounded-xl shadow-2xl flex flex-col">
                        <CardContent className="p-0 flex-grow">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-2xl font-bold text-blue-400 flex items-center">
                                    <BarChart2 className="mr-2 w-6 h-6" /> {selectedProject ? `${selectedProject.name} Chart` : 'Token Chart'}
                                </h2>
                                {/* Price/MCap Toggle */}
                                <div className="flex bg-gray-800 rounded-lg p-1">
                                    <Button
                                        onClick={() => setChartDataType('price')}
                                        className={`px-3 py-1 text-sm ${chartDataType === 'price' ? 'bg-blue-600 hover:bg-blue-700' : 'bg-transparent text-gray-400 hover:text-white'}`}
                                    >
                                        Price (AVAX)
                                    </Button>
                                    <Button
                                        onClick={() => setChartDataType('mcap')}
                                        className={`px-3 py-1 text-sm ${chartDataType === 'mcap' ? 'bg-blue-600 hover:bg-blue-700' : 'bg-transparent text-gray-400 hover:text-white'}`}
                                    >
                                        MCap (USD)
                                    </Button>
                                </div>
                            </div>

                            {selectedProject ? (
                                <ResponsiveContainer width="100%" height={300}>
                                    <AreaChart data={projectChartData} margin={{ top: 5, right: 20, left: 10, bottom: 5 }}>
                                        <CartesianGrid strokeDasharray="3 3" stroke="#444" />
                                        <XAxis dataKey="time" stroke="#999" />
                                        <YAxis
                                            stroke="#999"
                                            domain={['auto', 'auto']}
                                            tickFormatter={(value) => chartDataType === 'price' ? value.toFixed(4) : `$${(value / 1000).toFixed(0)}K`}
                                        />
                                        <Tooltip content={CustomTooltip} />
                                        <defs>
                                            {/* Green if price increased, Red if price decreased from previous point */}
                                            <linearGradient id="colorArea" x1="0" y1="0" x2="0" y2="1">
                                                <stop offset="5%" stopColor={selectedProject.priceChange >= 0 ? "#82ca9d" : "#ff4d4f"} stopOpacity={0.8}/>
                                                <stop offset="95%" stopColor={selectedProject.priceChange >= 0 ? "#82ca9d" : "#ff4d4f"} stopOpacity={0}/>
                                            </linearGradient>
                                        </defs>
                                        <Area
                                            type="monotone"
                                            dataKey={chartDataType}
                                            stroke={selectedProject.priceChange >= 0 ? "#82ca9d" : "#ff4d4f"} // Green if up, Red if down from last trade
                                            fillOpacity={1}
                                            fill="url(#colorArea)"
                                            strokeWidth={2}
                                            dot={false}
                                        />
                                    </AreaChart>
                                </ResponsiveContainer>
                            ) : (
                                <p className="text-gray-500 text-center py-20">Select a token to view its chart.</p>
                            )}
                            {selectedProject && (
                                <div className="text-center mt-4 text-gray-300">
                                    Current Price: <span className="font-bold text-white">
                                        {selectedProject.currentPrice.toFixed(6)} AVAX
                                        {selectedProject.priceChange > 0 && <TrendingUp className="inline-block ml-1 w-4 h-4 text-green-400" />}
                                        {selectedProject.priceChange < 0 && <TrendingDown className="inline-block ml-1 w-4 h-4 text-red-400" />}
                                        {selectedProject.priceChange === 0 && selectedProject.currentPrice === selectedProject.tokenPrice && <span className="ml-1 text-gray-500"> (Initial)</span>}
                                    </span>
                                </div>
                            )}
                        </CardContent>
                    </Card>
                </div>
            )}

            <footer className="text-center text-sm text-gray-500 pt-16 border-t border-gray-800 mt-12">
                <p>&copy; {new Date().getFullYear()} Mooch. All rights reserved.</p>
                <p className="mt-1">Mooch retains 3% of each successfully launched project. All applications undergo thorough review.</p>
            </footer>
        </div>
    );
};


// --- Main App Component ---
export default function App() {
  const [projects, setProjects] = useState([
    {
      name: "Project Orbit",
      shortDesc: "A DeFi lending protocol on Avalanche, focused on decentralized stablecoin loans.",
      fullDescription: "Project Orbit aims to revolutionize DeFi lending by providing a secure, transparent, and highly efficient platform for decentralized stablecoin loans on the Avalanche blockchain. It features dynamic interest rates, flash loans, and a robust risk management framework, governed by its community.",
      moochBurned: true,
      status: "Voting", // Starts ready for voting
      votes: 1250,
      presaleTarget: 250,
      minContribution: 10,
      maxContributionPerUser: 250,
      tokenPrice: 0.005,
      currentPrice: 0.005,
      circulatingSupply: 100000000, // Adjusted supply for more realistic percentage changes
      tokenAllocation: [ // NEW: Token allocation definition
          { name: "INTEGRITY DAO", percentage: 5 },
          { name: "MONEYBEARS DAO", percentage: 5 },
          { name: "Project Team", percentage: 15 },
          { name: "Liquidity Pool", percentage: 20 },
      ],
      auditStatus: "Audited by CertiK",
      websiteUrl: "https://projectorbit.xyz",
      whitepaperUrl: "https://projectorbit.xyz/whitepaper.pdf",
      currentContributions: 0,
      userContributions: {},
      priceChange: 0, // Track last price change for UI indicator
      shillCount: 15,
      shillScore: 15 * SHILL_SCORE_INCREMENT,
      totalMoochBurned: 1000000,
    },
    {
      name: "MetaVerse Eats",
      shortDesc: "Food delivery NFTs linked to real meals, enhancing virtual-to-real experiences.",
      fullDescription: "MetaVerse Eats bridges the gap between virtual and real-world dining. Purchase an NFT that is redeemable for a gourmet meal delivered to your door. Each NFT includes unique digital art and exclusive access to virtual dining events within the metaverse, creating a truly immersive experience.",
      moochBurned: false,
      status: "Pending Burn", // Starts pending burn
      votes: 0,
      presaleTarget: 250,
      minContribution: 10,
      maxContributionPerUser: 250,
      tokenPrice: 0.001,
      currentPrice: 0.001,
      circulatingSupply: 500000000,
      tokenAllocation: [
          { name: "INTEGRITY DAO", percentage: 5 },
          { name: "MONEYBEARS DAO", percentage: 5 },
          { name: "Project Team", percentage: 15 },
          { name: "Liquidity Pool", percentage: 20 },
      ],
      auditStatus: "Not Applicable (NFT only)",
      websiteUrl: "https://metaverse-eats.com",
      whitepaperUrl: "https://metaverse-eats.com/concept.pdf",
      currentContributions: 0,
      userContributions: {},
      priceChange: 0,
      shillCount: 0,
      shillScore: 0,
      totalMoochBurned: 0,
    },
    {
      name: "Quantum Ledger",
      shortDesc: "A secure, quantum-resistant blockchain for supply chain management.",
      fullDescription: "Quantum Ledger is developing the next generation of blockchain technology, designed to be resistant to quantum computing attacks. Its primary application is in supply chain management, offering unparalleled security and transparency for tracking goods from origin to consumer.",
      moochBurned: true,
      status: "Under Review",
      votes: 0,
      presaleTarget: 0,
      minContribution: 0,
      maxContributionPerUser: 0,
      tokenPrice: 0.0001,
      currentPrice: 0.0001,
      circulatingSupply: 1000000000,
      tokenAllocation: [
          { name: "INTEGRITY DAO", percentage: 5 },
          { name: "MONEYBEARS DAO", percentage: 5 },
          { name: "Project Team", percentage: 15 },
          { name: "Liquidity Pool", percentage: 20 },
      ],
      auditStatus: "In Progress",
      websiteUrl: "https://quantumledger.io",
      whitepaperUrl: "https://quantumledger.io/overview.pdf",
      currentContributions: 0,
      userContributions: {},
      priceChange: 0,
      shillCount: 5,
      shillScore: 5 * SHILL_SCORE_INCREMENT,
      totalMoochBurned: 1000000,
    },
    {
      name: "AI Art Forge",
      shortDesc: "Platform for creating and trading AI-generated art as NFTs with creator royalties.",
      fullDescription: "AI Art Forge empowers artists and collectors alike by providing a seamless platform for generating unique AI-driven digital art and minting it as NFTs. It features built-in smart contracts to ensure perpetual royalties for creators on secondary sales.",
      moochBurned: true,
      status: "Voting",
      votes: 890,
      presaleTarget: 250,
      minContribution: 10,
      maxContributionPerUser: 250,
      tokenPrice: 0.008,
      currentPrice: 0.008,
      circulatingSupply: 200000000,
      tokenAllocation: [
          { name: "INTEGRITY DAO", percentage: 5 },
          { name: "MONEYBEARS DAO", percentage: 5 },
          { name: "Project Team", percentage: 15 },
          { name: "Liquidity Pool", percentage: 20 },
      ],
      auditStatus: "Audited by PeckShield",
      websiteUrl: "https://aiartforge.art",
      whitepaperUrl: "https://aiartforge.art/vision.pdf",
      currentContributions: 0,
      userContributions: {},
      priceChange: 0,
      shillCount: 10,
      shillScore: 10 * SHILL_SCORE_INCREMENT,
      totalMoochBurned: 1000000,
    },
  ]);

  const [showSubmissionForm, setShowSubmissionForm] = useState(false);
  const [newProjectName, setNewProjectName] = useState("");
  const [newProjectDesc, setNewProjectDesc] = useState("");
  const [searchTerm, setSearchTerm] = useState("");
  const [selectedProject, setSelectedProject] = useState(null);
  const [userHasMoochNFT, setUserHasMoochNFT] = useState(false);
  const [userConnectedXAccount, setUserConnectedXAccount] = useState(false);
  const [viewMode, setViewMode] = useState("arena");

  const [userAvaxBalance, setUserAvaxBalance] = useState(1000);
  const [userTokenBalances, setUserTokenBalances] = useState({});

  // --- Project Management Handlers ---
  const handleProjectSubmit = (e) => {
    e.preventDefault();
    if (newProjectName && newProjectDesc) {
      const newProject = {
        name: newProjectName,
        shortDesc: newProjectDesc,
        fullDescription: "Awaiting full description and detailed presale information. Please check back after Mooch has been burned and the project has been reviewed.",
        moochBurned: false,
        status: "Pending Burn",
        votes: 0,
        presaleTarget: 250,
        minContribution: 10,
        maxContributionPerUser: 250,
        tokenPrice: 0.01,
        currentPrice: 0.01,
        circulatingSupply: 100000000, // Default circulating supply for new projects
        tokenAllocation: [ // Default allocation for new projects
            { name: "INTEGRITY DAO", percentage: 5 },
            { name: "MONEYBEARS DAO", percentage: 5 },
            { name: "Project Team", percentage: 15 },
            { name: "Liquidity Pool", percentage: 20 },
        ],
        auditStatus: "Pending Review",
        websiteUrl: "",
        whitepaperUrl: "",
        currentContributions: 0,
        userContributions: {},
        priceChange: 0,
        shillCount: 0,
        shillScore: 0,
        totalMoochBurned: 0,
      };
      setProjects([...projects, newProject]);
      setNewProjectName("");
      setNewProjectDesc("");
      setShowSubmissionForm(false);
      console.log(`Project "${newProject.name}" submitted! Please burn 1M $Mooch to proceed.`);
    } else {
      console.error("Please fill in both project name and description.");
    }
  };

  const handleBurnMooch = (projectName) => {
    setProjects(prevProjects =>
      prevProjects.map(project =>
        project.name === projectName
          ? { ...project, moochBurned: true, status: "Submitted", totalMoochBurned: (project.totalMoochBurned || 0) + 1000000 }
          : project
      )
    );
    setSelectedProject(prevProject =>
      prevProject && prevProject.name === projectName
        ? { ...prevProject, moochBurned: true, status: "Submitted", totalMoochBurned: (prevProject.totalMoochBurned || 0) + 1000000 }
        : prevProject
    );
    console.log(`1M $Mooch burned for "${projectName}"! Project is now submitted.`);
  };

  const handleSendForReview = (projectName) => {
    setProjects(prevProjects =>
      prevProjects.map(project =>
        project.name === projectName
          ? { ...project, status: "Under Review" }
          : project
      )
    );
    setSelectedProject(prevProject =>
      prevProject && prevProject.name === projectName
        ? { ...prevProject, status: "Under Review" }
        : prevProject
    );
    console.log(`Project "${projectName}" sent for Money Bears review.`);
  };

  const handleAcceptReview = (projectName) => {
    setProjects(prevProjects =>
      prevProjects.map(project =>
        project.name === projectName
          ? { ...project, status: "Voting", shillScore: Math.floor(Math.random() * 50) + 50 }
          : project
      )
    );
    setSelectedProject(prevProject =>
      prevProject && prevProject.name === projectName
        ? { ...prevProject, status: "Voting", shillScore: Math.floor(Math.random() * 50) + 50 }
        : prevProject
    );
    console.log(`Money Bears accepted "${projectName}"! It's now in Voting.`);
  };


  const handleSimulatePresale = (projectName) => {
    setProjects(prevProjects =>
      prevProjects.map(project =>
        project.name === projectName
          ? { ...project, status: "Presale Active" }
          : project
      )
    );
    setSelectedProject(prevProject =>
      prevProject && prevProject.name === projectName
        ? { ...prevProject, status: "Presale Active" }
        : prevProject
    );
    console.log(`Presale launched for "${projectName}"!`);
  };

  const handleContribute = (projectName, amount, userId) => {
    setProjects(prevProjects =>
      prevProjects.map(project => {
        if (project.name === projectName) {
          const newCurrentContributions = project.currentContributions + amount;
          const newUserContributions = {
              ...project.userContributions,
              [userId]: (project.userContributions[userId] || 0) + amount
          };
          let newStatus = project.status;
          if (newCurrentContributions >= project.presaleTarget && project.status !== "Launched") {
            newStatus = "Launched";
            console.log(`Congratulations! "${projectName}" has been officially Launched!`);
          }
          const tokensReceived = (amount / project.tokenPrice);
          setUserTokenBalances(prevBalances => ({
              ...prevBalances,
              [projectName]: (prevBalances[projectName] || 0) + tokensReceived
          }));
          setUserAvaxBalance(prevAvax => prevAvax - amount);

          return {
            ...project,
            currentContributions: newCurrentContributions,
            userContributions: newUserContributions,
            status: newStatus,
          };
        }
        return project;
      })
    );
    setSelectedProject(prevProject => {
        if (prevProject && prevProject.name === projectName) {
            const newCurrentContributions = prevProject.currentContributions + amount;
            const newUserContributions = {
                ...prevProject.userContributions,
                [userId]: (prevProject.userContributions[userId] || 0) + amount
            };
            let newStatus = prevProject.status;
            if (newCurrentContributions >= prevProject.presaleTarget && prevProject.status !== "Launched") {
                newStatus = "Launched";
            }
            return {
                ...prevProject,
                currentContributions: newCurrentContributions,
                userContributions: newUserContributions,
                status: newStatus,
            };
        }
        return prevProject;
    });
  };

  const handleShillProject = useCallback((projectName) => {
      setProjects(prevProjects =>
          prevProjects.map(project =>
              project.name === projectName
                  ? {
                      ...project,
                      shillCount: (project.shillCount || 0) + 1,
                      shillScore: ((project.shillCount || 0) + 1) * SHILL_SCORE_INCREMENT
                    }
                  : project
          )
      );
      console.log(`Shilled "${projectName}"! Shill Score increased.`);
  }, []);

  const handlePerformTrade = useCallback((
    projectName,
    tradeDirection,
    inputAmount,
    outputAmount,
    gasFee,
    priceChange
  ) => {
    setProjects(prevProjects =>
      prevProjects.map(project => {
        if (project.name === projectName) {
          const newCurrentPrice = Math.max(0.000001, project.currentPrice + priceChange);
          return {
            ...project,
            currentPrice: newCurrentPrice,
            priceChange: priceChange
          };
        }
        return project;
      })
    );

    setUserAvaxBalance(prevAvax => {
      if (tradeDirection === 'buy') {
        return prevAvax - inputAmount - gasFee;
      } else { // sell
        return prevAvax + outputAmount - gasFee;
      }
    });

    setUserTokenBalances(prevTokens => {
      const newTokens = { ...prevTokens };
      if (tradeDirection === 'buy') {
        newTokens[projectName] = (newTokens[projectName] || 0) + outputAmount;
      } else { // sell
        newTokens[projectName] = (newTokens[projectName] || 0) - inputAmount;
      }
      return newTokens;
    });
  }, []);

  const filteredProjects = projects.filter(project =>
    project.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
    project.shortDesc.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const launchedProjects = projects.filter(project => project.status === "Launched");

  const burnLeaderboard = [...projects].sort((a, b) => b.totalMoochBurned - a.totalMoochBurned);

  const shillLeaderboard = [...projects]
    .filter(p => p.shillScore > 0)
    .sort((a, b) => b.shillScore - a.shillScore)
    .slice(0, 10);

  if (viewMode === "trade") {
    return (
        <TradeLaunchedMemes
            launchedProjects={launchedProjects}
            onBackToArena={() => setViewMode("arena")}
            userAvaxBalance={userAvaxBalance}
            userTokenBalances={userTokenBalances}
            onPerformTrade={handlePerformTrade}
            userConnectedXAccount={userConnectedXAccount}
            onShillProject={handleShillProject}
        />
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-950 to-black text-white p-6 space-y-12 font-sans">
      <div className="text-center space-y-4 pt-8">
        <h1 className="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600 drop-shadow-lg animate-pulse">
          ðŸ”¥ Mooch Launch Arena
        </h1>
        <p className="text-lg text-gray-300 max-w-2xl mx-auto leading-relaxed">
          Submit your innovative project and burn 1M $Mooch to enter the arena. Community votes the best for presale.
        </p>
      </div>

      <div className="flex flex-col sm:flex-row justify-center gap-4 my-8">
        <Button
          onClick={() => setShowSubmissionForm(!showSubmissionForm)}
          className="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105"
        >
          <Lightbulb className="mr-2 h-5 w-5" />
          {showSubmissionForm ? "Close Submission" : "Submit New Project"}
        </Button>
        <Button
          variant="outline"
          className="border-gray-600 text-gray-300 hover:bg-gray-800 hover:border-gray-500 py-3 px-6 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105"
        >
          <BarChart2 className="mr-2 h-5 w-5" />
          View Current Voting
        </Button>
        <Button
            variant="secondary"
            className="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105"
            onClick={() => setViewMode("trade")}
        >
            ðŸš€ Trade Launched Memes
        </Button>
      </div>

      <div className="text-center my-6 space-y-2">
          <p className="text-gray-300 text-sm">
            1 $Mooch = <span className="font-bold text-green-400">${MOOCH_USD_PRICE.toFixed(8)}</span>
          </p>
          {/* NFT and X Account Status */}
          <div className="flex flex-col sm:flex-row justify-center gap-4 items-center mt-4">
            <Button
                onClick={() => setUserHasMoochNFT(!userHasMoochNFT)}
                className={`font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-300 ${userHasMoochNFT ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'}`}
            >
                {userHasMoochNFT ? 'âœ… Mooch NFT in Wallet' : 'âŒ Mooch NFT Not Found'}
            </Button>
            <Button
                onClick={() => setUserConnectedXAccount(!userConnectedXAccount)}
                className={`font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-300 ${userConnectedXAccount ? 'bg-blue-500 hover:bg-blue-600' : 'bg-gray-500 hover:bg-gray-600'}`}
            >
                <Twitter className="mr-2 h-5 w-5" /> {userConnectedXAccount ? 'X Account Connected' : 'Connect X Account'}
            </Button>
          </div>
          <p className="text-gray-400 text-sm mt-2">Toggle states to simulate wallet connections.</p>
          <p className="text-gray-400 text-sm mt-1">Your AVAX Balance: <span className="font-semibold text-white">{userAvaxBalance.toFixed(4)} AVAX</span></p>
          {Object.keys(userTokenBalances).length > 0 && (
              <p className="text-gray-400 text-sm mt-1">Your Tokens:
                  {Object.entries(userTokenBalances).map(([tokenName, balance]) => (
                      <span key={tokenName} className="font-semibold text-white ml-2">
                          {balance.toFixed(4)} {tokenName}
                      </span>
                  ))}
              </p>
          )}
      </div>


      {showSubmissionForm && (
        <Card className="bg-gray-900 border border-purple-700 p-6 max-w-xl mx-auto shadow-2xl rounded-xl animate-fade-in">
          <CardContent>
            <h2 className="text-2xl font-bold text-center mb-6 text-purple-400">Submit Your Project</h2>
            <form onSubmit={handleProjectSubmit} className="space-y-4">
              <div>
                <label htmlFor="projectName" className="block text-gray-300 text-sm font-medium mb-2">Project Name</label>
                <Input
                  id="projectName"
                  type="text"
                  placeholder="e.g., Decentralized AI Hub"
                  value={newProjectName}
                  onChange={(e) => setNewProjectName(e.target.value)}
                  className="bg-gray-800 border border-gray-700 text-white placeholder-gray-500 focus:border-purple-500 focus:ring-purple-500 focus:ring-1"
                  required
                />
              </div>
              <div>
                <label htmlFor="projectDesc" className="block text-gray-300 text-sm font-medium mb-2">Short Description</label>
                <Textarea
                  id="projectDesc"
                  placeholder="Briefly describe your project's innovation and purpose."
                  value={newProjectDesc}
                  onChange={(e) => setNewProjectDesc(e.target.value)}
                  className="bg-gray-800 border border-gray-700 text-white placeholder-gray-500 min-h-[80px] focus:border-purple-500 focus:ring-purple-500 focus:ring-1"
                  required
                />
              </div>
              <Button
                type="submit"
                className="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105"
              >
                Submit Project
              </Button>
            </form>
          </CardContent>
        </Card>
      )}

      {/* Mooch Burn Leaderboard */}
      <div className="max-w-3xl mx-auto bg-gray-900 border border-yellow-700 p-6 rounded-xl shadow-2xl space-y-4">
        <h2 className="text-2xl font-bold text-center text-yellow-400 flex items-center justify-center">
            ðŸ”¥ Mooch Burn Leaderboard
        </h2>
        {burnLeaderboard.length > 0 ? (
            <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-700">
                    <thead className="bg-gray-800">
                        <tr>
                            <th scope="col" className="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider rounded-tl-lg">
                                Project
                            </th>
                            <th scope="col" className="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                $Mooch Burned
                            </th>
                            <th scope="col" className="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider rounded-tr-lg">
                                Value (USD)
                            </th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-800">
                        {burnLeaderboard.map((project, index) => (
                            <tr key={index} className={`${index % 2 === 0 ? 'bg-gray-900' : 'bg-gray-850'} hover:bg-gray-700 transition-colors`}>
                                <td className="px-4 py-4 whitespace-nowrap text-sm font-medium text-white">
                                    {project.name}
                                </td>
                                <td className="px-4 py-4 whitespace-nowrap text-sm text-orange-400">
                                    {project.totalMoochBurned.toLocaleString()}
                                </td>
                                <td className="px-4 py-4 whitespace-nowrap text-sm text-right text-green-400">
                                    ${(project.totalMoochBurned * MOOCH_USD_PRICE).toFixed(2)}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        ) : (
            <p className="text-center text-gray-500">No projects have burned Mooch yet. Be the first!</p>
        )}
      </div>

      {/* Shill Score Leaderboard */}
      <div className="max-w-3xl mx-auto bg-gray-900 border border-pink-700 p-6 rounded-xl shadow-2xl space-y-4">
        <h2 className="text-2xl font-bold text-center text-pink-400 flex items-center justify-center">
            ðŸ“ˆ Shill Score Leaderboard (Top 10)
        </h2>
        {shillLeaderboard.length > 0 ? (
            <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-700">
                    <thead className="bg-gray-800">
                        <tr>
                            <th scope="col" className="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider rounded-tl-lg">
                                Rank
                            </th>
                            <th scope="col" className="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                Project
                            </th>
                            <th scope="col" className="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider rounded-tr-lg">
                                Shill Score
                            </th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-800">
                        {shillLeaderboard.map((project, index) => (
                            <tr key={index} className={`${index % 2 === 0 ? 'bg-gray-900' : 'bg-gray-850'} hover:bg-gray-700 transition-colors`}>
                                <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-300">
                                    #{index + 1}
                                </td>
                                <td className="px-4 py-4 whitespace-nowrap text-sm font-medium text-white">
                                    {project.name}
                                </td>
                                <td className="px-4 py-4 whitespace-nowrap text-sm text-right text-pink-400">
                                    {project.shillScore}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        ) : (
            <p className="text-center text-gray-500">No projects have a shill score yet. Shill a meme to get started!</p>
        )}
      </div>

      <div className="relative max-w-lg mx-auto mb-8">
        <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
        <Input
          type="text"
          placeholder="Search projects..."
          value={searchTerm}
          onChange={(e) => setSearchTerm(e.target.value)}
          className="w-full pl-10 pr-4 py-2 bg-gray-800 border border-gray-700 text-white placeholder-gray-500 rounded-lg focus:border-purple-500 focus:ring-purple-500 focus:ring-1 shadow-inner transition-all duration-200"
        />
      </div>

      <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
        {filteredProjects.length > 0 ? (
          filteredProjects.map((project, idx) => (
            <Card
              key={idx}
              className="bg-gray-900 border border-gray-700 hover:border-purple-500 transition-all duration-300 transform hover:-translate-y-1 hover:shadow-lg group"
            >
              <CardContent className="p-6 space-y-3">
                <h2 className="text-2xl font-bold text-purple-300 group-hover:text-purple-400 transition-colors duration-300 flex items-center">
                  {project.name}
                </h2>
                <p className="text-gray-400 text-base leading-relaxed line-clamp-3">{project.shortDesc}</p>
                <div className="flex items-center gap-2 text-sm mt-3">
                  <span className="text-yellow-400 font-medium flex items-center">
                    <Lightbulb className="w-4 h-4 mr-1" />
                    Status: <span className="ml-1 font-semibold">{project.status}</span>
                  </span>
                </div>
                {project.moochBurned ? (
                  <p className="text-sm text-green-400 flex items-center mt-1">
                    <CheckCircle className="w-4 h-4 mr-1" />
                    1M Mooch Burned
                  </p>
                ) : (
                  <p className="text-sm text-red-400 flex items-center mt-1">
                    <XCircle className="w-4 h-4 mr-1" />
                    Mooch Burn Pending
                  </p>
                )}
                 {/* Display Shill Score on cards */}
                {project.shillScore > 0 && (
                    <p className="text-sm text-pink-400 flex items-center mt-1">
                        <Scale className="w-4 h-4 mr-1" />
                        Shill Score: {project.shillScore}
                    </p>
                )}
                {(project.status === "Voting" || project.status === "Presale Active") && (
                  <p className="text-sm text-blue-400 flex items-center mt-1">
                    <BarChart2 className="w-4 h-4 mr-1" />
                    Votes: {project.votes.toLocaleString()}
                  </p>
                )}
                {project.status === "Presale Active" && (
                    <p className="text-sm text-lime-400 flex items-center mt-1">
                        <DollarSign className="w-4 h-4 mr-1" />
                        Raised: ${project.currentContributions.toLocaleString()} / ${project.presaleTarget.toLocaleString()} AVAX
                    </p>
                )}
                {project.status === "Launched" && (
                    <p className="text-sm text-green-400 flex items-center mt-1 font-semibold">
                        <TrendingUp className="w-4 h-4 mr-1" /> Launched!
                    </p>
                )}
                <div className="mt-4 pt-4 border-t border-gray-800 flex justify-between items-center">
                    <Button
                        variant="ghost"
                        className="text-purple-400 hover:bg-purple-900 hover:text-white transition-colors duration-200"
                        onClick={() => setSelectedProject(project)}
                    >
                        View Details
                    </Button>
                </div>
              </CardContent>
            </Card>
          ))
        ) : (
          <p className="col-span-full text-center text-gray-500 text-lg py-10">
            No projects found matching your search.
          </p>
        )}
      </div>

      <ProjectDetailsModal
        project={selectedProject}
        onClose={() => setSelectedProject(null)}
        onBurnMooch={handleBurnMooch}
        onSimulatePresale={handleSimulatePresale}
        onContribute={handleContribute}
        userHasMoochNFT={userHasMoochNFT}
        onSendForReview={handleSendForReview}
        onAcceptReview={handleAcceptReview}
      />

      <footer className="text-center text-sm text-gray-500 pt-16 border-t border-gray-800 mt-12">
        <p>&copy; {new Date().getFullYear()} Mooch. All rights reserved.</p>
        <p className="mt-1">Mooch retains 3% of each successfully launched project. All applications undergo thorough review.</p>
      </footer>
    </div>
  );
}
